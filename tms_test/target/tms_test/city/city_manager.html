<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>城市-节点 管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <style>
        a {
            text-decoration: none;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <div style="margin-top: 10px;">
            <form class="form-inline">
                <div class="form-group">
                    <label>城市名称</label>
                    <input type="text" class="form-control" name="city_name" id="city_name" v-model="CityInfo.city_name" placeholder="输入城市名称">
                </div>
                <button type="button" class="btn btn-info" @click="pageCityInfo()">查询</button>
                <!-- 弹出一个当前页面的HTML片断 片断的id为myModal -->
                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#myModal"
                    @click="loadOrgName()">新建城市信息</button>
            </form>
        </div>
        <hr>
        <div>
            <table class="table table-stripted table-bordered table-condensed table-hover">
                <thead>
                    <tr>
                        <template v-for="item in city_hd">
                            <th>{{item}}</th>
                        </template>
                        <th><input type="checkbox" v-model="checkbox" @change="select()">全选/全不选</th>
                    </tr>
                </thead>
                <tbody v-show="city_bd">
                    <template v-for="(car,index) in pageInfo">
                        <tr>
                            <td ><button type="button" class="btn btn-warning" data-toggle="modal" data-target="#selectModal" @click="getNode(index)">查看节点</button><button type="button" class="btn btn-warning" data-toggle="modal" data-target="#updateModal"
                                                               @click="updateName1(index)" >修改</button ><button type="button" class="btn btn-warning" @click="updateNode(index)">作废</button></td>
                            <td><template v-if="car.city_state==1">正常</template>
                                <template v-else>已作废</template>
                                <input type="hidden"  v-model="car.city_state">
                            </td>
                            <td>{{car.city_code}}</td>
                            <td>{{car.city_name}}</td>
                            <td>{{car.org_name}}</td>
                            <td>{{car.d_center}}</td>
                            <td><input type="checkbox" :value="car.id" @change="changeChk()" v-model="checkedNames">
                            </td>

                        </tr>
                    </template>

                </tbody>
            </table>
        </div>

        <!-- 弹出的新建城市信息模态框 -->
        <div class="modal fade" id="myModal">
            <form class="form-horizontal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <!-- 头部 -->
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">新建城市信息</h4>
                    </div>
                    <!--身体 -->
                    <div class="modal-body">
                        <!-- 需要填的内容 -->
                        <div>

                                <fieldset title="新建城市">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">城市代码</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="f_city_id" name="f_city_id"
                                                style="background-color: darkgray;" disabled>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">城市名称</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="f_city_name" name="f_city_name" v-model="params.cityName">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">机构名称</label>
                                        <div class="col-sm-5">
                                            <!-- 此选择框的数据是要通过查询数据库的 -->
                                            <select v-model="params.orgId" class="form-control" name="org_name" id="org_name">
                                                <option v-for="org in orgs" :value="org.id">{{org.org_name}}</option>
                                            </select>
                                        </div>
                                    </div>

                                </fieldset>

                        </div>
                    </div>
                    <!--脚-->
                    <div class="modal-footer">
                        <button type="button" @click="createCity()" data-dismiss="modal" class="btn btn-primary">创建</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
             </div>
            </form>
        </div>
        <!-- 弹出的修改城市信息模态框 -->
        <div class="modal fade" id="updateModal">
            <form class="form-horizontal">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <!-- 头部 -->
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="updataModalLabel">修改城市信息</h4>
                        </div>
                        <!--身体 -->
                        <div class="modal-body">
                            <!-- 需要填的内容 -->
                            <div>

                                <fieldset title="修改城市">
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">城市代码</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="u_city_id" name="u_city_id"
                                                   style="background-color: darkgray;" disabled>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">城市名称</label>
                                        <div class="col-sm-10">
                                            <input type="text" id="u_city_name" name="u_city_name" v-model="City.cityName">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-2 control-label">机构名称</label>
                                        <div class="col-sm-5">
                                            <!-- 此选择框的数据是要通过查询数据库的 -->
                                            <select v-model="City.orgId" class="form-control" name="u_org_name" id="u_org_name">
                                                <option v-for="org in orgs" :value="org.id">{{org.org_name}}</option>
                                            </select>
                                        </div>
                                    </div>

                                </fieldset>

                            </div>
                        </div>
                        <!--脚-->
                        <div class="modal-footer">
                            <button type="button" @click="updateCity()"  class="btn btn-primary">修改</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <!-- 弹出的查看节点信息模态框 -->
        <div class="modal fade" id="selectModal">
            <form class="form-horizontal">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                    <table  class="table table-stripted table-bordered table-condensed table-hover">
                        <thead>
                        <tr>
                            <template v-for="item in node_hb">
                                <th>{{item}}</th>
                            </template>
                        </tr>
                        </thead>
                        <tbody v-show="city_bd">
                        <template v-for="node in nodeInfo">
                            <tr>
                             <td>{{node.node_type}}</td>
                             <td>{{node.node_name}}</td>
                             <td><template v-if="node.node_state==1">正常</template>
                                 <template v-else>已作废</template>
                                 <input type="hidden" v-model="node.node_state"></td>
                            </tr>
                        </template>

                        </tbody>
                    </table>
                    </div>
                </div>
            </form>
        </div>

<!-- 分页-->
    <nav aria-label="Page navigation" style="text-align: center;">
        <ul class="pagination">
            <li :class="CityInfo.pageNo==1?'disabled':''" @click="prePage()">
               <a aria-label="Previous">
                   <span aria-hidden="true" style="cursor: pointer">&laquo;</span>
               </a>
            </li>
           <li :class="index==CityInfo.pageNo?'active':''" v-for="index in totalPag" @click="curPage(index)">
               <a>{{index}}</a>
           </li>
            <li :class="CityInfo.pageNo==totalPag?'disabled':''" @click="nextPage()">
               <a aria-label="Next" >
                  <span aria-hidden="true" style="cursor: pointer">&raquo;</span>
               </a>
            </li>
        </ul>
    </nav>
</div>
</body>
<script src="/tms_test/js/jquery-3.5.1.js"></script>
<script src="/tms_test/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<script>

    var myModalVue = new Vue({
        el: '#app',
        data: {
            city_hd: ['操作', '状态', '城市代码', '城市名称', '机构名称', '配送中心名称'],
            node_hb: ['节点类型','节点名称','节点状态'],
            city_bd: true,
            checkbox: false,
            checkedNames:[],
            checkbox1: [1, 2, 3, 4, 5],
            "totalPag":1,//总页数
            "rows":1,//总条数
            "City_id":"",
            "carType1": "",
            "pageInfo":"",
            "nodeInfo":"",
            "orgs": [],
            "params":{
            "cityName":"",
            "orgId":1
            },
          "City":{
              "id":"",
              "cityName":"",
              "orgId":1
           },
            "CityInfo":{
                "pageNo":1,//当前页数
                "pageSize":5,//固定条数
                "city_name":""
            },
            "Node":{
                "id":""
            },
            "Nodes":{
                "city_id":""
            }


        },
        watch: {
            checkedNames: function (newVal) {
                console.log(newVal)
            },
        },
        mounted: function () {
            var _self = this;
            $.get("/tms_test/data/tms_org.json", function (orgData) {
                _self.orgs2 = orgData.orgs
            }, "json")
        },
        methods: {
            select: function () {
                if (this.checkbox) {
                    this.checkedNames = this.checkbox1
                } else {
                    this.checkedNames = []
                }
            },
            changeChk: function () {
                if (this.checkedNames.length < 5) {
                    this.checkbox = false
                } else if (this.checkedNames.length ==5) {
                    this.checkbox = true
                }
            },
            //创建城市
            createCity:function () {
               $.post("/tms_test/add_city" ,this.params,function (data) {
                // alert(this.params.cityName)
                // alert(this.params.orgId)
                   if (data.msg=='success') {
                       alert("创建成功")
                   }else {
                       alert("创建失败")
                   }
            },'json')
                //$('#myModal').modal('hide');
            },
            //修改城市信息
            updateCity:function(){
              $.post("/tms_test/updateCity",this.City,function (orgData1) {
                  if (orgData1.msg=='success') {
                      alert("修改成功")
                  }else {
                      alert("修改失败")
                  }
              },"json")
                $('#updateModal').modal('hide');
              this.pageCityInfo()
            },
            //查询机构信息
            loadOrgName:function () {
                var _self=this
                $.get("/tms_test/orgs_mgr",function (orgData) {
                   // console.log(orgData)
                    _self.orgs=orgData;
                },"json")
            },
            getNode:function(index){
                var _self=this
                _self.Node.id=(_self.CityInfo.pageNo-1)*5+(index+1)
                $.post("/tms_test/getnode",this.Node,function (NodeData) {
                    _self.nodeInfo=NodeData;
                    console.log(NodeData)
                },"json")
            },
            updateNode:function(index){
                var _self=this
                _self.Nodes.city_id=(_self.CityInfo.pageNo-1)*5+(index+1)
                console.log(_self.Nodes.city_id)
                $.get("/tms_test/update_node",this.Nodes,function (NodesData) {
                    if (NodesData.msg=='success') {
                        alert("已成功作废")
                    }else if(NodesData.msg=='fail') {
                        alert("请查看该城市下节点是否都已作废")
                    }
                },"json")
                this.pageCityInfo()
            },
            updateName1:function(index){
                this.loadOrgName()
                var _self=this
                _self.City.id=(_self.CityInfo.pageNo-1)*5+(index+1)
            },
            // updateCityInfo:function () {
            //     var _self=this
            //     $.get("/tms_test/city_info",this.City, function (Data) {
            //         _self.carType1 = Data
            //         console.log(carType1)
            //     }, "json")
            // },
            //分页
            pageCityInfo:function () {
                var _self=this
                $.get("/tms_test/page",this.CityInfo,function (pageData) {
                   _self.pageInfo=pageData.list
                   _self.totalPag=pageData.totalPages
                   _self.rows=pageData.totalRecords
                    console.log(pageData)
                },"json")
            },
            //当前页
            curPage:function (index) {
                this.CityInfo.pageNo=index;
                this.pageCityInfo();
            },
            //上一页
            prePage:function () {
                if (this.CityInfo.pageNo>1){
                    this.CityInfo.pageNo--;
                    this.pageCityInfo();
                }

            },
            //下一页
            nextPage:function () {
                if (this.CityInfo.pageNo<this.totalPag) {
                    this.CityInfo.pageNo++;
                    this.pageCityInfo();
                }

            },
            updateName:function () {

                this.loadOrgName();
            },
        }
    })

    //alert(myModalVue.orgs)

    //Vue
    function loadOrgName() {
        //alert("loading")
        //查询数据 使用ajax
        /*$.get("/data/tms_org.json", function(orgData){
            console.log(orgData)
            var orgs = orgData.orgs //获取的数据是数组
            //使用JQuery的选择器选择id为org_name的DOM元素
            //使用id选择器
            //遍历数组
            for(var i=0;i<orgs.length;i++) {
                //拼接HTML代码 

                var opt = '<option value="'+orgs[i].id+'">'+orgs[i].name+'</option>'
                $("#org_name").append(opt)
            }
        }, "json")*/
    }

</script>

</html>